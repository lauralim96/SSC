---
title: "data visualizations"
author: "Laura"
date: "2023-04-09"
output: pdf_document
---

```{r setup, include=FALSE}
library(ggplot2)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
df <- read.csv("/Users/lauralim/Dropbox/SSC data/ED_OUT_waiting .csv")

df$REGISTRATION_toTriage = as.numeric(df$REGISTRATION_toTriage)
df$PIA_toTriage = as.numeric(df$PIA_toTriage)
df$INIT_TREAT_LOC_toTriage = as.numeric(df$INIT_TREAT_LOC_toTriage)
df$PHYS_REASSESSMENT_toTriage = as.numeric(df$PHYS_REASSESSMENT_toTriage)
df$CONSULT_REQUESTED_toTriage = as.numeric(df$CONSULT_REQUESTED_toTriage)
df$LAB_toTriage = as.numeric(df$LAB_toTriage)
df$DI_toTriage = as.numeric(df$DI_toTriage)
df$DISPOSITION_toTriage = as.numeric(df$DISPOSITION_toTriage)
df$ED_DEPARTURE_toTriage = as.numeric(df$ED_DEPARTURE_toTriage)

df$registration = as.numeric(df$registration)
df$pia = as.numeric(df$pia)
df$init_treat_loc = as.numeric(df$init_treat_loc)
df$phys_reassessment = as.numeric(df$phys_reassessment)
df$consult_requested = as.numeric(df$consult_requested)
df$lab = as.numeric(df$lab)
df$di = as.numeric(df$di)
df$disposition = as.numeric(df$disposition)
df$after_disposition = as.numeric(df$after_disposition)

#Stacked bar plot

bar_df <- data.frame(matrix(ncol=3, nrow=63))
colnames(bar_df) <- c("Disposition Group", "Triage Steps", "Waiting Time")
# 9 triage steps x 7 disposition groups

#Filling up column 1
for (i in 0:6) {
  for (j in 1:9) {
    if (i==0) {
      bar_df[9*i+j,1] <- "Active"
    }
    else if (i==1) {
      bar_df[9*i+j,1] <- "Admitted"
    }
    else if (i==2) {
      bar_df[9*i+j,1] <- "Died"
    }
    else if (i==3) {
      bar_df[9*i+j,1] <- "Discharged"
    }
    else if (i==4) {
      bar_df[9*i+j,1] <- "LWBS"
    }
    else if (i==5) {
      bar_df[9*i+j,1] <- "LAMA"
    }
    else if (i==6) {
      bar_df[9*i+j,1] <- "Transferred"
    }
  }
}

#Filling up column 2
for (i in 0:6) {
  bar_df[9*i + 1,2] <- "Registration"
  bar_df[9*i + 2,2] <- "Entering treatment space"
  bar_df[9*i + 3,2] <- "Physician assessment"
  bar_df[9*i + 4,2] <- "Physician re-assessment"
  bar_df[9*i + 5,2] <- "Lab test"
  bar_df[9*i + 6,2] <- "DI test"
  bar_df[9*i + 7,2] <- "ED MD request"
  bar_df[9*i + 8,2] <- "Disposition decision"
  bar_df[9*i + 9,2] <- "Departure"
}

#Filling up column 3
for (i in 1:63) {
  for (j in 0:6) {
    bar_df[j*9 + 1,3] <-   median(df$registration[df$DISP_GROUP == bar_df[j*9 + 1,1]], na.rm=TRUE)
    bar_df[j*9 + 2,3] <-   median(df$init_treat_loc[df$DISP_GROUP == bar_df[j*9 + 2,1]], na.rm=TRUE)
    bar_df[j*9 + 3,3] <-   median(df$pia[df$DISP_GROUP == bar_df[j*9 + 3,1]], na.rm=TRUE)
    bar_df[j*9 + 4,3] <-   median(df$phys_reassessment[df$DISP_GROUP == bar_df[j*9 + 4,1]], na.rm=TRUE)
    bar_df[j*9 + 5,3] <-   median(df$lab[df$DISP_GROUP == bar_df[j*9 + 5,1]], na.rm=TRUE)
   bar_df[j*9 + 6,3] <-   median(df$di[df$DISP_GROUP == bar_df[j*9 + 6,1]], na.rm=TRUE)
   bar_df[j*9 + 7,3] <-   median(df$consult_requested[df$DISP_GROUP == bar_df[j*9 + 7,1]], na.rm=TRUE)
   bar_df[j*9 + 8,3] <-   median(df$disposition[df$DISP_GROUP == bar_df[j*9 + 8,1]], na.rm=TRUE)
   bar_df[j*9 + 9,3] <-   median(df$after_disposition[df$DISP_GROUP == bar_df[j*9 + 9,1]], na.rm=TRUE)
  }
}

#Heat map
heat_df <- data.frame(matrix(ncol=3, nrow=54))
colnames(heat_df) <- c("Age group", "Triage Code", "Median LOS in ED (minutes)")

#Filling up column 1
for (i in 0:9) {
  for (j in 1:6) {
    if (i==0) {
      heat_df[6*i+j,1] <- "0-10"
    }
    else if (i==1) {
      heat_df[6*i+j,1] <- "10=20"
    }
    else if (i==2) {
      heat_df[6*i+j,1] <- "20-30"
    }
    else if (i==3) {
      heat_df[6*i+j,1] <- "30=40"
    }
    else if (i==4) {
      heat_df[6*i+j,1] <- "40-50"
    }
    else if (i==5) {
      heat_df[6*i+j,1] <- "50-60"
    }
    else if (i==6) {
      heat_df[6*i+j,1] <- "60-70"
    }
    else if (i==7) {
      heat_df[6*i+j,1] <- "70-80"
    }
    else if (i==8) {
      heat_df[6*i+j,1] <- "80-95"
    }
  }
}

#Filling up column 2
for (i in 0:8) {
  heat_df[6*i + 1,2] <- "1"
  heat_df[6*i + 2,2] <- "2"
  heat_df[6*i + 3,2] <- "3"
  heat_df[6*i + 4,2] <- "4"
  heat_df[6*i + 5,2] <- "5"
  heat_df[6*i + 6,2] <- "9"
}

#Filling up column 3
for (j in 0:8) {
  subset_1 <- subset(df, df$TRIAGECODE == 1 & (df$AGE_GROUP == 2*j | df$AGE_GROUP == 2*j+1))
  subset_2 <- subset(df, df$TRIAGECODE == 2 & (df$AGE_GROUP == 2*j | df$AGE_GROUP == 2*j+1))
  subset_3 <- subset(df, df$TRIAGECODE == 3 & (df$AGE_GROUP == 2*j | df$AGE_GROUP == 2*j+1))
  subset_4 <- subset(df, df$TRIAGECODE == 4 & (df$AGE_GROUP == 2*j | df$AGE_GROUP == 2*j+1))
  subset_5 <- subset(df, df$TRIAGECODE == 5 & (df$AGE_GROUP == 2*j | df$AGE_GROUP == 2*j+1))
  subset_6 <- subset(df, df$TRIAGECODE == 9 & (df$AGE_GROUP == 2*j | df$AGE_GROUP == 2*j+1))
  
  heat_df[j*6 + 1,3] <-   median(subset_1$VISIT_LOS_MINUTES,na.rm =TRUE)
  heat_df[j*6 + 2,3] <-   median(subset_2$VISIT_LOS_MINUTES,na.rm =TRUE)
  heat_df[j*6 + 3,3] <-   median(subset_3$VISIT_LOS_MINUTES,na.rm =TRUE)
  heat_df[j*6 + 4,3] <-   median(subset_4$VISIT_LOS_MINUTES,na.rm =TRUE)
  heat_df[j*6 + 5,3] <-   median(subset_5$VISIT_LOS_MINUTES,na.rm =TRUE)
  heat_df[j*6 + 6,3] <-   median(subset_6$VISIT_LOS_MINUTES,na.rm =TRUE)

  }


#Box plot
box_df <- data.frame(matrix(ncol=3, nrow=12))
colnames(box_df) <- c("Flag of hospitalization in previous 3 years", "Triage Code", "Median LOS in ED (minutes)")

for (i in 0:1) {
  for (j in 1:6) {
    if (i==0) {
      box_df[6*i+j,1] <- "Yes"
    }
    else if (i==1) {
      box_df[6*i+j,1] <- "No"
    }
  }
}

#Filling up column 2
for (i in 0:1) {
  box_df[6*i + 1,2] <- "1"
  box_df[6*i + 2,2] <- "2"
  box_df[6*i + 3,2] <- "3"
  box_df[6*i + 4,2] <- "4"
  box_df[6*i + 5,2] <- "5"
  box_df[6*i + 6,2] <- "9"
}

#Filling up column 3
for (j in 0:1) {
  subset_1 <- subset(df, df$TRIAGECODE == 1 & (df$X_3YRhospitalaztion == j ))
  subset_2 <- subset(df, df$TRIAGECODE == 2 & (df$X_3YRhospitalaztion == j ))
  subset_3 <- subset(df, df$TRIAGECODE == 3 & (df$X_3YRhospitalaztion == j ))
  subset_4 <- subset(df, df$TRIAGECODE == 4 & (df$X_3YRhospitalaztion == j ))
  subset_5 <- subset(df, df$TRIAGECODE == 5 & (df$X_3YRhospitalaztion == j ))
  subset_6 <- subset(df, df$TRIAGECODE == 9 & (df$X_3YRhospitalaztion == j ))
  
  box_df[j*6 + 1,3] <-   median(subset_1$VISIT_LOS_MINUTES,na.rm =TRUE)
  box_df[j*6 + 2,3] <-   median(subset_2$VISIT_LOS_MINUTES,na.rm =TRUE)
  box_df[j*6 + 3,3] <-   median(subset_3$VISIT_LOS_MINUTES,na.rm =TRUE)
  box_df[j*6 + 4,3] <-   median(subset_4$VISIT_LOS_MINUTES,na.rm =TRUE)
  box_df[j*6 + 5,3] <-   median(subset_5$VISIT_LOS_MINUTES,na.rm =TRUE)
  box_df[j*6 + 6,3] <-   median(subset_6$VISIT_LOS_MINUTES,na.rm =TRUE)
  
}

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=TRUE}
#Bar plot
ggplot(bar_df, aes(x=`Disposition Group`,y = `Waiting Time`, fill=`Triage Steps`)) +
  geom_col(position = "stack") + 
  labs(title="Distribution of Time Spent in ED by Triage and Disposition Group")

#Heat map
ggplot(heat_df, aes(`Age group`, `Triage Code`)) +                           # Create heatmap with ggplot2
  geom_tile(aes(fill = `Median LOS in ED (minutes)`))  +
  labs(title="Length of Stay in ED by Acuity Level and Age")

#Boxplot
ggplot(subset, aes(x = factor(`TRIAGECODE`), y = `VISIT_LOS_MINUTES`,fill=factor(`X_3YRhospitalaztion`))) +
  geom_boxplot(position=position_dodge()) +
  ggtitle("Length of Stay in ED against Acuity Level") + 
  labs(x="Triage Code", y="Length of stay in ED (minutes)", fill="Flag of hospitalization in the past 3 years")



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
