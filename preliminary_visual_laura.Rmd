---
title: "preliminary_visual_laura"
author: "Laura"
date: "2023-04-09"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages("ggplot2")
library(ggplot2)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
df <- read.csv("/Users/lauralim/Dropbox/SSC data/ED_OUT_waiting .csv")
df$REGISTRATION_toTriage = as.numeric(df$REGISTRATION_toTriage)
df$PIA_toTriage = as.numeric(df$PIA_toTriage)
df$INIT_TREAT_LOC_toTriage = as.numeric(df$INIT_TREAT_LOC_toTriage)
df$PHYS_REASSESSMENT_toTriage = as.numeric(df$PHYS_REASSESSMENT_toTriage)
df$CONSULT_REQUESTED_toTriage = as.numeric(df$CONSULT_REQUESTED_toTriage)
df$LAB_toTriage = as.numeric(df$LAB_toTriage)
df$DI_toTriage = as.numeric(df$DI_toTriage)
df$DISPOSITION_toTriage = as.numeric(df$DISPOSITION_toTriage)
df$ED_DEPARTURE_toTriage = as.numeric(df$ED_DEPARTURE_toTriage)

df$registration = as.numeric(df$registration)
df$pia = as.numeric(df$pia)
df$init_treat_loc = as.numeric(df$init_treat_loc)
df$phys_reassessment = as.numeric(df$phys_reassessment)
df$consult_requested = as.numeric(df$consult_requested)
df$lab = as.numeric(df$lab)
df$di = as.numeric(df$di)
df$disposition = as.numeric(df$disposition)
df$after_disposition = as.numeric(df$after_disposition)

bar_df <- data.frame(matrix(ncol=3, nrow=63))
colnames(bar_df) <- c("Disposition Group", "Triage Steps", "Waiting Time")
# 9 triage steps x 7 disposition groups

#Filling up column 1
for (i in 0:6) {
  for (j in 1:9) {
    if (i==0) {
      bar_df[9*i+j,1] <- "Active"
    }
    else if (i==1) {
      bar_df[9*i+j,1] <- "Admitted"
    }
    else if (i==2) {
      bar_df[9*i+j,1] <- "Died"
    }
    else if (i==3) {
      bar_df[9*i+j,1] <- "Discharged"
    }
    else if (i==4) {
      bar_df[9*i+j,1] <- "LWBS"
    }
    else if (i==5) {
      bar_df[9*i+j,1] <- "LAMA"
    }
    else if (i==6) {
      bar_df[9*i+j,1] <- "Transferred"
    }
  }
}

#Filling up column 2
for (i in 0:6) {
  bar_df[9*i + 1,2] <- "Registration"
  bar_df[9*i + 2,2] <- "Entering treatment space"
  bar_df[9*i + 3,2] <- "Physician assessment"
  bar_df[9*i + 4,2] <- "Physician re-assessment"
  bar_df[9*i + 5,2] <- "Lab test"
  bar_df[9*i + 6,2] <- "DI test"
  bar_df[9*i + 7,2] <- "ED MD request"
  bar_df[9*i + 8,2] <- "Disposition decision"
  bar_df[9*i + 9,2] <- "Departure"
}

#Filling up column 3
for (i in 1:63) {
  for (j in 0:6) {
    bar_df[j*9 + 1,3] <-   median(df$registration[df$DISP_GROUP == bar_df[j*9 + 1,1]], na.rm=TRUE)
    bar_df[j*9 + 2,3] <-   median(df$init_treat_loc[df$DISP_GROUP == bar_df[j*9 + 2,1]], na.rm=TRUE)
    bar_df[j*9 + 3,3] <-   median(df$pia[df$DISP_GROUP == bar_df[j*9 + 3,1]], na.rm=TRUE)
    bar_df[j*9 + 4,3] <-   median(df$phys_reassessment[df$DISP_GROUP == bar_df[j*9 + 4,1]], na.rm=TRUE)
    bar_df[j*9 + 5,3] <-   median(df$lab[df$DISP_GROUP == bar_df[j*9 + 5,1]], na.rm=TRUE)
   bar_df[j*9 + 6,3] <-   median(df$di[df$DISP_GROUP == bar_df[j*9 + 6,1]], na.rm=TRUE)
   bar_df[j*9 + 7,3] <-   median(df$consult_requested[df$DISP_GROUP == bar_df[j*9 + 7,1]], na.rm=TRUE)
   bar_df[j*9 + 8,3] <-   median(df$disposition[df$DISP_GROUP == bar_df[j*9 + 8,1]], na.rm=TRUE)
   bar_df[j*9 + 9,3] <-   median(df$after_disposition[df$DISP_GROUP == bar_df[j*9 + 9,1]], na.rm=TRUE)
  }
}

for (i in 1:63) {
  for (j in 0:6)
    bar_df[j*9 + 1,3] <-   median(df$registration[df$DISP_GROUP == bar_df[j*9 + 1,1]], na.rm=TRUE)
  bar_df[j*9 + 2,3] <-   median(df$init_treat_loc[df$DISP_GROUP == bar_df[j*9 + 2,1]], na.rm=TRUE)
  bar_df[j*9 + 3,3] <-   median(df$pia[df$DISP_GROUP == bar_df[j*9 + 3,1]], na.rm=TRUE)
  bar_df[j*9 + 4,3] <-   median(df$phys_reassessment[df$DISP_GROUP == bar_df[j*9 + 4,1]], na.rm=TRUE)
  bar_df[j*9 + 5,3] <-   median(df$lab[df$DISP_GROUP == bar_df[j*9 + 5,1] & is.numeric(df$lab)])
  bar_df[j*9 + 6,3] <-   median(df$di[df$DISP_GROUP == bar_df[j*9 + 6,1] & is.numeric(df$di)])
  bar_df[j*9 + 7,3] <-   median(df$consult_requested[df$DISP_GROUP == bar_df[j*9 + 7,1] & is.numeric(df$consult_requested)])
  bar_df[j*9 + 8,3] <-   median(df$disposition[df$DISP_GROUP == bar_df[j*9 + 8,1] & is.numeric(df$disposition)])
  bar_df[j*9 + 9,3] <-   median(df$after_disposition[df$DISP_GROUP == bar_df[j*9 + 9,1] & is.numeric(df$after_disposition)])
}
```

## Including Plots

You can also embed plots, for example:

```{r , echo=TRUE}
ggplot(bar_df, aes(x=`Disposition Group`,y = `Waiting Time`, fill=`Triage Steps`)) +
  geom_col(position = "stack") + 
  #scale_fill_manual(values=c("red", "blue", "yellow")) +
  #geom_line(filter(df, Type.of.Visits %in% "ED Visits"), mapping = aes(x = Timeline, y = Visits*0.75),colour = "red") +
  #geom_line(filter(df, Type.of.Visits %in% "Polyclinic Visits With Nebuliser Prescription"), mapping = aes(x = Timeline, y = Visits*0.75),colour = "green") +
  #scale_x_discrete(breaks=c("Jan-19","Mar-19","May-19","Jul-19","Sep-19","Nov-19","Jan-20","Mar-20","May-20","Jul-20","Sep-20")) +
  theme(#axis.text.x = element_text(size=20,angle=45), 
       axis.text.y = element_text(size=20), 
        #axis.title=element_text(size=20,face="bold"), 
        #plot.title=element_text(size=28,hjust=0.5, face="bold"),
        #legend.title = element_text(size=24),
        #legend.position = "bottom",
        #legend.text = element_text(size=24),  
        #panel.background = element_rect(fill = "white"),
       plot.background = element_rect(fill = "white")) + 
  #guides(fill=guide_legend(nrow=3, byrow=TRUE)) +
  #geom_line(aes(y=a+b*PRR)) + annotate("text", x=18.5, y=1550, label="PRR", size=9) +
  #geom_segment(aes(x = 18.5, y = 1500, xend = 20.5, yend = 1400), arrow = arrow(length = unit(0.5, "cm"))) +
  #scale_y_continuous(name="Number of Episodes Per Month Per Hospital/Clinic", sec.axis = sec_axis(~ (. - a)/b,name="PRR")) + 
  labs(title="Distribution of Time Spent in ED by Triage and Disposition Group")
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
